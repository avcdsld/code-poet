name: daily-poem

on:
  schedule:
    - cron: "5 15 * * *" # JST 00:05
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    environment: auto-poet
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - name: Generate with GPT
        run: node engine/generate.mjs gpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      - name: Generate with Claude
        run: node engine/generate.mjs claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      - name: Import GPG key
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import || true
            gpg --list-secret-keys --keyid-format=long
          fi
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if [ -n "$GPG_KEY_ID" ]; then
            git config --local user.signingkey "$GPG_KEY_ID"
            git config --local commit.gpgsign true
            if [ -n "$GPG_PASSPHRASE" ]; then
              mkdir -p ~/.gnupg
              echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
              echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf || true
              echo "batch" >> ~/.gnupg/gpg.conf
            fi
          fi
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      - name: Commit and push changes
        run: |
          git add poems/ prompts/ manifests/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ -n "$GPG_KEY_ID" ]; then
              if [ -n "$GPG_PASSPHRASE" ]; then
                export GPG_TTY=""
                echo "$GPG_PASSPHRASE" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --yes --sign-key "$GPG_KEY_ID" > /dev/null 2>&1 || true
                git -c gpg.program=gpg commit -S -m "poems for $(date +%Y-%m-%d)" || \
                echo "$GPG_PASSPHRASE" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --sign --local-user "$GPG_KEY_ID" --output /tmp/test.sig /dev/null && \
                git commit -S -m "poems for $(date +%Y-%m-%d)"
              else
                git commit -S -m "poems for $(date +%Y-%m-%d)"
              fi
            else
              git commit -m "poems for $(date +%Y-%m-%d)"
            fi
            git push
          fi
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
